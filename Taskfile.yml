version: '3'

vars:
  CONFIG_FILE: ./deno.json
  IMPORT_MAP: ./import_map.json
  LOCK_FILE: ./.lock.json
  COVERAGE_DIR: ./tests/cov_profile
  #authorizations
  ALLOW_READ: .
  ALLOW_WRITE: .
  ALLOW_NET_REPO: deno.land,esm.sh,cdn.esm.sh,cdn.jsdelivr.net,unpkg.com
  ALLOW_NET_SERVER: 0.0.0.0:8000,eu1-intense-kodiak-36255.upstash.io
  ALLOW_ENV: NODE_ENV,DENO_DIR,FRUGAL_REFRESH_KEY,FRUGAL_DEV

env:
  DENO_DIR: ./.deno_dir

tasks:
  fmt:
    cmds:
      - deno fmt 
          --config {{.CONFIG_FILE}}

  test:
    deps: 
      - unit-test
      - integration-test

  unit-test:
    cmds:
      - deno --unstable test
          --config {{.CONFIG_FILE}}
          --import-map={{.IMPORT_MAP}}
          --allow-read={{.ALLOW_READ}}
          --no-check
          --coverage={{.COVERAGE_DIR}}/unit
          --jobs
          --shuffle
          {{.CLI_ARGS}}
          tests/unit/*

  integration-test:
    cmds:
      - deno --unstable test
          --config {{.CONFIG_FILE}}
          --import-map={{.IMPORT_MAP}}
          --allow-read={{.ALLOW_READ}}
          --allow-write={{.ALLOW_WRITE}}
          --allow-env={{.ALLOW_ENV}}
          --no-check
          --coverage={{.COVERAGE_DIR}}/integration
          --jobs
          --shuffle
          {{.CLI_ARGS}}
          tests/integration/*

  coverage:
    cmds:
      - deno --unstable coverage
          {{.COVERAGE_DIR}}
          --lcov 
          --include=packages
          --output={{.COVERAGE_DIR}}/unit/cov_profile.lcov
      - deno --unstable coverage
          {{.COVERAGE_DIR}}
          --lcov 
          --include=packages
          --output={{.COVERAGE_DIR}}/integration/cov_profile.lcov

  dev-doc:
    env:
      FRUGAL_DEV: true
    cmds:
      - deno --unstable run
          --config {{.CONFIG_FILE}}
          --import-map={{.IMPORT_MAP}}
          --allow-read={{.ALLOW_READ}}
          --allow-write={{.ALLOW_WRITE}}
          --allow-net={{.ALLOW_NET_REPO}},{{.ALLOW_NET_SERVER}}
          --allow-env={{.ALLOW_ENV}}
          --no-check
          --watch=docs/data
          {{.CLI_ARGS}}
          docs/serve.ts

  build-doc:
    cmds:
      - deno --unstable run
          --config {{.CONFIG_FILE}}
          --import-map={{.IMPORT_MAP}}
          --allow-read={{.ALLOW_READ}}
          --allow-write={{.ALLOW_WRITE}}
          --allow-net={{.ALLOW_NET_REPO}}
          --allow-env={{.ALLOW_ENV}}
          --no-check
          {{.CLI_ARGS}}
          docs/build.ts

  serve-doc:
    cmds:
      - deno --unstable run
          --config {{.CONFIG_FILE}}
          --import-map={{.IMPORT_MAP}}
          --allow-read={{.ALLOW_READ}}
          --allow-write={{.ALLOW_WRITE}}
          --allow-net={{.ALLOW_NET_REPO}},{{.ALLOW_NET_SERVER}}
          --allow-env={{.ALLOW_ENV}}
          --no-check
          {{.CLI_ARGS}}
          docs/serve.ts

  example:
    cmds:
      - deno --unstable run
          --config {{.CONFIG_FILE}}
          --import-map={{.IMPORT_MAP}}
          --allow-read={{.ALLOW_READ}}
          --allow-write={{.ALLOW_WRITE}}
          --allow-net={{.ALLOW_NET_REPO}},{{.ALLOW_NET_SERVER}}
          --allow-env={{.ALLOW_ENV}}
          --no-check
          {{.CLI_ARGS}}